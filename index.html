<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ©º Ø³ÛŒØ³ØªÙ… Ø§Ø¯ÛŒØª Ø´ÛŒÙØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒÚ©</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --neon:#ff1a4d;
  --bg1:#070407;
  --bg2:#300018;
}
html,body{height:100%}
body{
  font-family:"Vazirmatn",system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  margin:0;
  background: linear-gradient(120deg,var(--bg1),var(--bg2),#120010);
  background-size:300% 300%;
  animation: bgMove 18s ease-in-out infinite;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:28px;
  color:#fff;
}
@keyframes bgMove{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

.neon-title{ color:var(--neon); text-shadow:0 0 12px rgba(255,26,77,0.95),0 0 28px rgba(255,26,77,0.45); font-weight:800; }
.glow { box-shadow:0 10px 40px rgba(255,26,77,0.06); border:1px solid rgba(255,26,77,0.08); background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.22)); border-radius:12px; }

#pasteArea { user-select:none; -webkit-user-select:none; outline:none; transition:box-shadow .18s ease, transform .18s ease; }
#pasteArea:focus{ box-shadow:0 18px 60px rgba(255,26,77,0.12); transform:translateY(-3px); }

.err-shake{ animation:shake .45s ease; }
@keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-8px)}50%{transform:translateX(7px)}75%{transform:translateX(-5px)}100%{transform:translateX(0)}}

.panel{ width:100%; max-width:1100px; background:linear-gradient(180deg, rgba(6,6,6,0.82), rgba(12,6,10,0.75)); padding:16px; border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,0.6); border:1px solid rgba(255,26,77,0.05); }

.rank-dropdown{ position:absolute; left:6%; right:6%; top: calc(100% + 8px); background:linear-gradient(180deg,#070707,#0e0608); border-radius:10px; border:1px solid rgba(255,26,77,0.12); box-shadow:0 12px 40px rgba(0,0,0,0.6); transform-origin:top center; transform:translateY(-8px) scaleY(.96); opacity:0; transition:transform .26s cubic-bezier(.2,.9,.2,1), opacity .22s ease; z-index:60; pointer-events:none; padding:12px; }
.rank-dropdown.open{ transform:translateY(0) scaleY(1); opacity:1; pointer-events:auto; }
.rank-dropdown .opt{ padding:10px 14px; font-size:1rem; border-radius:8px; cursor:pointer; margin-bottom:6px; }
.rank-dropdown .opt:hover{ background:rgba(255,26,77,0.08); }

.days-dropdown{ position:absolute; left:6%; right:6%; top: calc(100% + 8px); background:linear-gradient(180deg,#070707,#0e0608); border-radius:10px; border:1px solid rgba(255,26,77,0.12); box-shadow:0 12px 40px rgba(0,0,0,0.6); padding:12px; transform-origin:top center; transform:translateY(-8px) scaleY(.96); opacity:0; transition:transform .26s cubic-bezier(.2,.9,.2,1), opacity .22s ease; z-index:60; pointer-events:none; display:grid; grid-template-columns:repeat(4,1fr); gap:6px; }
.days-dropdown.open{ transform:translateY(0) scaleY(1); opacity:1; pointer-events:auto; }
.days-dropdown .opt-btn{ padding:10px; font-size:1rem; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .14s ease; }
.days-dropdown .opt-btn:hover{ background:rgba(255,26,77,0.06) }
.days-dropdown .opt-btn.selected{ background:linear-gradient(90deg,var(--neon),#ff6b86); box-shadow:0 8px 30px rgba(255,26,77,0.12); color:#120; }

.cell-content{ display:flex; flex-direction:column; align-items:center; justify-content:flex-start; height:100%; }
th .cell-content{ display:flex; align-items:flex-start; justify-content:center; height:60px; }

#copyToast{ position:fixed; top:20px; left:50%; transform:translateX(-50%) translateY(-8px); background:linear-gradient(90deg,#00e676,#00c853); color:#021; padding:12px 18px; border-radius:10px; font-weight:800; box-shadow:0 10px 40px rgba(0,0,0,0.45); opacity:0; transition:opacity .28s ease, transform .28s ease; z-index:9999; pointer-events:none; }
#copyToast.show{ opacity:1; transform:translateX(-50%) translateY(0); pointer-events:auto; }

.big-ui *{ font-size:1.03rem; }
@media(min-width:768px){ .big-ui *{ font-size:1.08rem } .neon-title{ font-size:2.2rem } }

input.t-input{ background:transparent; border:none; border-bottom:1px solid rgba(255,26,77,0.12); color:#fff; padding:6px; text-align:center; width:100%; }
input[type="time"]{ text-align:center; }
.rank-btn, .days-display { display:flex; align-items:center; justify-content:center; width:100%; height:100%; cursor:pointer; }
</style>
</head>
<body class="big-ui">
<div style="width:100%;max-width:1100px;display:flex;flex-direction:column;gap:18px;align-items:center;">
<h1 class="neon-title text-3xl md:text-4xl">ğŸ©º Ø³ÛŒØ³ØªÙ… Ø§Ø¯ÛŒØª Ø´ÛŒÙØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒÚ©</h1>

<div id="pasteWrap" class="w-full max-w-3xl">
  <div id="pasteArea" tabindex="0" class="glow cursor-text select-none p-8 rounded-xl text-center text-2xl md:text-3xl neon-title" aria-label="Ù…Ø­Ù„ Ù¾ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ú©Ø¯ â€” Ctrl+V">
    ğŸ” Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ø±Ø§ Ù¾ÛŒØ³Øª Ú©Ù†ÛŒØ¯ (Ctrl + V)
  </div>
</div>

<div id="editorWrap" class="panel hidden">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <div style="font-size:1.25rem;font-weight:700;color:var(--neon)">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ø´ÛŒÙØªâ€ŒÙ‡Ø§</div>
    <div style="display:flex;gap:10px;align-items:center">
      <button id="addBtn" class="px-4 py-2 rounded-lg font-semibold border border-green-500 hover:bg-green-600/10 transition">â• Ø§ÙØ²ÙˆØ¯Ù† Ù†ÙØ±</button>
      <button id="exportBtn" class="px-5 py-2 rounded-lg font-bold bg-gradient-to-r from-red-600 to-red-500 hover:from-red-700 hover:to-red-600 transition text-white shadow-lg">ğŸ“‹ Ø®Ø±ÙˆØ¬ÛŒ Ù…ØªÙ†</button>
    </div>
  </div>

  <div style="overflow:auto;max-height:66vh">
    <table class="w-full table-fixed text-center">
      <thead>
        <tr class="text-left text-red-200" style="border-bottom:1px solid rgba(255,26,77,0.08)">
          <th class="p-3"><div class="cell-content">Ù†Ø§Ù…</div></th>
          <th class="p-3"><div class="cell-content">Ø±Ù†Ú©</div></th>
          <th class="p-3"><div class="cell-content">Ø±ÙˆØ²Ù‡Ø§</div></th>
          <th class="p-3"><div class="cell-content">Ø´Ø±ÙˆØ¹</div></th>
          <th class="p-3"><div class="cell-content">Ù¾Ø§ÛŒØ§Ù†</div></th>
          <th class="p-3"><div class="cell-content">Ø¹Ù…Ù„ÛŒØ§Øª</div></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<div id="copyToast">âœ… Ø®Ø±ÙˆØ¬ÛŒ Ø¯Ø± Ú©Ù„ÛŒÙ¾â€ŒØ¨ÙˆØ±Ø¯ Ú©Ù¾ÛŒ Ø´Ø¯</div>

<script>
// JS Ú©Ø§Ù…Ù„ Ùˆ Ø¹Ù…Ù„ÛŒØ§ØªÛŒ
const pasteArea = document.getElementById('pasteArea');
const pasteWrap = document.getElementById('pasteWrap');
const editorWrap = document.getElementById('editorWrap');
const tableBody = document.getElementById('tableBody');
const addBtn = document.getElementById('addBtn');
const exportBtn = document.getElementById('exportBtn');
const copyToast = document.getElementById('copyToast');

let originalCode = '';
let shifts = [];
let extractedRange = null;

const RANKS = ["Head Of Hospital","Medical Director","Hospital Assistant","Professor"];
const DAY_OPTS = ["H","Z","F","0","1","2","3","4","5","6"];

pasteArea.focus();

function escapeHtml(s){ if(s===undefined||s===null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

function findShiftsBlock(code){
  const idx = code.indexOf('const shifts');
  if(idx===-1) return null;
  const eq = code.indexOf('=', idx);
  if(eq===-1) return null;
  let firstBracket = code.indexOf('[', eq);
  if(firstBracket===-1) return null;
  let i = firstBracket, depth=0, inStr=false, strChar='', esc=false;
  for(;i<code.length;i++){
    const ch=code[i];
    if(inStr){
      if(esc) esc=false; else { if(ch==='\\') esc=true; else if(ch===strChar){inStr=false; strChar='';} }
      continue;
    }else{
      if(ch==='"'||ch==="'"||ch==='`'){inStr=true; strChar=ch; continue;}
      if(ch==='[') depth++; else if(ch===']'){depth--; if(depth===0){let end=i+1; while(end<code.length&&/\s/.test(code[end]))end++; if(code[end]===';')end++; return {start:firstBracket,end:end,text:code.slice(firstBracket,i+1)};}}
    }
  }
  return null;
}

function safeParseArray(text){
  try{ return new Function('return ('+text+');')(); } catch(e){ console.warn(e); return null; }
}

function extractShiftsFromCode(code){
  const block=findShiftsBlock(code);
  if(!block) return null;
  const arr=safeParseArray(block.text);
  if(!Array.isArray(arr)) return null;
  const norm=arr.map(p=>{
    const out={name:p.name, rank:p.rank||'Professor', times:[]};
    const t=(p.times&&p.times[0])?p.times[0]:{days:'H', start:'00:00', end:'00:00'};
    let daysArr=[];
    if(typeof t.days==='string') daysArr=[t.days];
    else if(typeof t.days==='number') daysArr=[t.days];
    else if(Array.isArray(t.days)) daysArr=t.days.map(v=>typeof v==='string'&&/^\d+$/.test(v)?Number(v):v);
    out.times=[{daysArr:daysArr, start:t.start||'00:00', end:t.end||'00:00'}];
    return out;
  });
  return {arr:norm, range:block};
}

function formatDaysLabel(arr){if(!arr||arr.length===0)return '---'; return arr.map(v=>String(v)).join(', ');}

function renderTable(){
  tableBody.innerHTML='';
  shifts.forEach((p, idx)=>{
    const tr=document.createElement('tr');
    tr.className='border-b border-red-900/30';
    const t0=p.times[0];
    const daysLabel=formatDaysLabel(t0.daysArr);
    tr.innerHTML=`
      <td class="p-3"><input data-field="name" class="t-input" value="${escapeHtml(p.name||'')}" /></td>
      <td class="p-3 relative">
        <div class="rank-btn" data-idx="${idx}">${escapeHtml(p.rank||'')}</div>
        <div class="rank-dropdown" data-idx="${idx}">${RANKS.map(r=>`<div class="opt">${r}</div>`).join('')}</div>
      </td>
      <td class="p-3 relative">
        <div class="days-display">${escapeHtml(daysLabel)}</div>
        <div class="days-dropdown" data-idx="${idx}">${DAY_OPTS.map(d=>`<div class="opt-btn" data-val="${d}">${d}</div>`).join('')}</div>
      </td>
      <td class="p-3"><input data-field="start" type="time" class="t-input" value="${escapeHtml(t0.start||'00:00')}" /></td>
      <td class="p-3"><input data-field="end" type="time" class="t-input" value="${escapeHtml(t0.end||'00:00')}" /></td>
      <td class="p-3"><button class="del-btn px-3 py-1 rounded-lg bg-red-700/90 hover:bg-red-700 text-white font-semibold">Ø­Ø°Ù</button></td>
    `;
    tr.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const f=e.target.dataset.field;
        if(f==='name') shifts[idx].name=e.target.value;
        else if(f==='start') shifts[idx].times[0].start=e.target.value;
        else if(f==='end') shifts[idx].times[0].end=e.target.value;
      });
    });
    tr.querySelector('.del-btn').addEventListener('click', ()=>{ shifts.splice(idx,1); renderTable(); });
    
    const rankBtn=tr.querySelector('.rank-btn');
    const rankDropdown=tr.querySelector('.rank-dropdown');
    rankBtn.addEventListener('click', (ev)=>{
      document.querySelectorAll('.rank-dropdown.open').forEach(d=>d.classList.remove('open'));
      rankDropdown.classList.toggle('open');
    });
    rankDropdown.querySelectorAll('.opt').forEach(opt=>{
      opt.addEventListener('click', ev=>{
        shifts[idx].rank=ev.currentTarget.textContent;
        renderTable();
      });
    });

    const daysDisplay=tr.querySelector('.days-display');
    const daysDropdown=tr.querySelector('.days-dropdown');
    daysDropdown.querySelectorAll('.opt-btn').forEach(btn=>{
      const val=btn.dataset.val;
      if(t0.daysArr.some(v=>String(v)===val)) btn.classList.add('selected');
    });
    daysDisplay.addEventListener('click', ()=>{
      document.querySelectorAll('.days-dropdown.open').forEach(d=>d.classList.remove('open'));
      daysDropdown.classList.toggle('open');
    });
    daysDropdown.querySelectorAll('.opt-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const val=btn.dataset.val;
        const parsedVal=/^\d+$/.test(val)?Number(val):val;
        const arr=shifts[idx].times[0].daysArr;
        const foundIndex=arr.findIndex(v=>String(v)===String(parsedVal));
        if(foundIndex===-1){ arr.push(parsedVal); btn.classList.add('selected'); }
        else { arr.splice(foundIndex,1); btn.classList.remove('selected'); }
        daysDisplay.textContent=formatDaysLabel(arr);
      });
    });

    tableBody.appendChild(tr);
  });

  document.addEventListener('click', (ev)=>{
    if(!ev.target.closest('.rank-btn')&&!ev.target.closest('.rank-dropdown')) document.querySelectorAll('.rank-dropdown.open').forEach(d=>d.classList.remove('open'));
    if(!ev.target.closest('.days-display')&&!ev.target.closest('.days-dropdown')) document.querySelectorAll('.days-dropdown.open').forEach(d=>d.classList.remove('open'));
  });
}

function showPasteError(msg){
  pasteArea.textContent=msg;
  pasteArea.classList.add('err-shake','text-yellow-300','font-bold');
  setTimeout(()=>pasteArea.classList.remove('err-shake'),520);
}

pasteArea.addEventListener('paste', (e)=>{
  e.preventDefault();
  const text=(e.clipboardData||window.clipboardData).getData('text')||'';
  if(!text.trim()){ showPasteError('Ù…Ø­ØªÙˆØ§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª â€” Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù…Ø¹ØªØ¨Ø± Ù¾ÛŒØ³Øª Ú©Ù†ÛŒØ¯'); return;}
  originalCode=text;
  const extracted=extractShiftsFromCode(originalCode);
  if(!extracted){ showPasteError('âš ï¸ Ø¨Ø®Ø´ shifts ÛŒØ§ÙØª Ù†Ø´Ø¯! Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ù…Ø¹ØªØ¨Ø± Ù¾ÛŒØ³Øª Ú©Ù†ÛŒØ¯'); return;}
  shifts=extracted.arr;
  extractedRange=extracted.range;
  shifts=shifts.map(s=>{ if(!s.times||!s.times[0].daysArr) s.times=[{daysArr:['H'], start:'00:00', end:'00:00'}]; return s; });
  pasteWrap.classList.add('hidden');
  editorWrap.classList.remove('hidden');
  renderTable();
});

addBtn.addEventListener('click', ()=>{
  shifts.push({name:'', rank:'Professor', times:[{daysArr:['H'], start:'00:00', end:'00:00'}]});
  renderTable();
});

exportBtn.addEventListener('click', ()=>{
  if(!originalCode||!extractedRange){ alert('Ú©Ø¯ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.'); return;}
  const outArray=shifts.map(p=>{
    const obj={name:p.name||'', rank:p.rank||'', times:[]};
    const t=p.times[0];
    const daysArr=Array.isArray(t.daysArr)?t.daysArr.slice():[t.daysArr];
    let daysForExport;
    if(daysArr.length===1&&(daysArr[0]==='H'||daysArr[0]==='F'||daysArr[0]==='Z')) daysForExport=daysArr[0];
    else daysForExport=daysArr.map(v=>typeof v==='string'&&/^\d+$/.test(v)?Number(v):v);
    obj.times.push({days:daysForExport, start:t.start||'00:00', end:t.end||'00:00'});
    return obj;
  });
  const newArrayText=JSON.stringify(outArray,null,2);
  const updatedCode=originalCode.slice(0, extractedRange.start)+newArrayText+originalCode.slice(extractedRange.end);
  navigator.clipboard.writeText(updatedCode).then(()=>{
    copyToast.classList.add('show'); setTimeout(()=>copyToast.classList.remove('show'),2000);
  }).catch(err=>alert('Ú©Ù¾ÛŒ Ø¨Ù‡ Ú©Ù„ÛŒÙ¾â€ŒØ¨ÙˆØ±Ø¯ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯: '+err));
});

window.addEventListener('load', ()=>setTimeout(()=>{ try{ pasteArea.focus(); }catch(e){} },80));
window.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='v'){ if(editorWrap.classList.contains('hidden')) try{ pasteArea.focus(); }catch(e){} } });
</script>
</body>
</html>
